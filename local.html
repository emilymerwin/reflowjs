<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width">

	<link rel="stylesheet" type="text/css" href="base.css">
	<link rel="stylesheet" href="simple-slideshow-styles.css">
	<link rel="stylesheet" href="timeline.css">
	<script src="marked.js"></script>
	<script src="packery.pkgd.min.js"></script>
	<script src="miso.ds.deps.ie.min.0.4.1.js"></script>
	<script src="better-simple-slideshow.min.js"></script>
	<script src="http://admin.brightcove.com/js/BrightcoveExperiences.js" type="text/javascript" ></script>
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBYupoTfmCt-mh6tCqrNkQnIUmWXuFopQQ">
    </script>
	<script>
		var reflowSettings = {
			googleKey: '1UwyrO_goSqP9UM-kjTNLM5lKNVj3y__coN_3KJWSLJo',
			maps: [],
			geocoder: new google.maps.Geocoder(),
			zoomLevel: 10,
		
		}
		
		//slideshow JS
	    var opts = {
            auto : false,
            fullScreen : false
        };
        
        var timelineRenderer = new marked.Renderer();
        
        timelineRenderer.list = function(body, ordered) {
  			var type = ordered ? 'ol' : 'ul';
  			if (ordered) {
  					return '<' + type + '>\n' + body + '</' + type + '>\n';
  			} else {
  				return '<' + type + ' class="timeline">\n' + body +'<li class="year long">&nbsp;</li> ' + '</' + type + '>\n';
			}
		};
		
		timelineRenderer.listitem = function(text) {
			dateRegex = /^((January|Jan\.?|February|Feb\.?|March|April|May|June|July|August|Aug\.?|September|Sept\.?|October|Oct\.?|November|Nov\.?|December|Dec\.?) ?(\d{1,2}(rd|nd|st)?\,? ?)?)?(\d{4})?$/;
			yearRegex = /^(\d{4})(\s*\-\s*\d{4})?$/;
			if (yearRegex.test(text)) {
				return '<li class="year">' + text + '</li>\n';

			} else if (dateRegex.test(text)) {
				return '<li class="year long">' + text + '</li>\n';
			} else {
  				return '<li class="event">' + text + '</li>\n';
  			}
  			
		};

		marked.setOptions({
			smartypants: true,
		});


    </script>
	
	<script type="text/javascript">
	
		brightcove.createExperiences();
		var obitName = new RegExp(getParameterByName("name"),'i');
		var pckry = {};
		
		// responsive slideshow from Mark Lee
		// http://themarklee.com/2013/12/26/simple-diy-responsive-slideshow-made-html5-css3-javascript/
		

		var ds = new Miso.Dataset({
		  //comment out importer to use a local file
		  //importer : Miso.Dataset.Importers.GoogleSpreadsheet,
	
		  //change url to correct local file name
		  //comment out url to use google spreadsheets
		  url: 'basic.jsonp',
		  jsonp: true,
		  parser : Miso.Dataset.Parsers.GoogleSpreadsheet,
		  key : "1AMZOgPH3JQfXafxjmp6J9IUPvDV8IO-cnWURr-u52L8",
		  worksheet : "1"
		});

		ds.fetch({ 
		  success : function() {
		  	obitdata = ds.rows(function(row) {return obitName.test(row.mugshotName)}).toJSON()[0];
		  	init(obitdata);
		  	var container = document.querySelector('#content');
		  	pckry = new Packery( container, {
			  "column": 320,
			  "itemSelector": ".box", 
			  "gutter": 10,
			  
			  //"rowHeight": 20,
			  //"transitionDuration": "0.4s",	
			  });
			pack();
			var i = setInterval(pack, 100);
			setTimeout(function(){clearInterval(i)},120000);
brightcove.createExperiences();
		  },
		  error : function() {
			//console.log("Google data didn't load.");
		  }
		});
		

	

		
		
		function brightcovePlayer(id) {
			html = '<!-- Start of Brightcove Player -->'
// 				+''
// 				+'<div style="display:none">'
// 				+'Janus Single Chromeless Player '
// 				+'</div>'
// 				+''
// 				+'<!--'
// 				+'By use of this code snippet, I agree to the Brightcove Publisher T and C '
// 				+'found at https://accounts.brightcove.com/en/terms-and-conditions/. '
// 				+'-->'
// 				+''
// 				//+'<script language="JavaScript" type="text/javascript" src="http://admin.brightcove.com/js/BrightcoveExperiences.js">\<\/script>'
// 				+''
				+'<object id="myExperience" class="BrightcoveExperience">'
				+'  <param name="bgcolor" value="#FFFFFF" />'
				+'  <param name="width" value="100%" />'
				+'  <param name="height" value="100%" />'
				+'  <param name="playerID" value="2418610043001" />'
				+'  <param name="playerKey" value="AQ~~,AAACLrx-GiE~,-R5NlQaAplIWhlMPcU5YDN5147VaN70m" />'
				+'  <param name="isVid" value="true" />'
				+'  <param name="isUI" value="true" />'
				+'  <param name="dynamicStreaming" value="true" />'
				+''
				+'  <param name="@videoPlayer" value="'+id+'" /> <!-- replace value with video ID -->'
				+'</object>'
// 				+''
// 				+'<!-- '
// 				+'This script tag will cause the Brightcove Players defined above it to be created as soon'
// 				+'as the line is read by the browser. If you wish to have the player instantiated only after'
// 				+'the rest of the HTML is processed and the page load is complete, remove the line.'
// 				+'-->'
// 				//+'<script type="text/javascript">brightcove.createExperiences();\<\/script>'
// 				+''
// 				+'<!-- End of Brightcove Player -->'
		
				return html;
			}
		
		
		function swap(id, content) {
			
			document.getElementById(id).innerHTML=content;
			//new_height = document.getElementById('inner'+id).clientHeight;
			//document.getElementById(id).style.height = new_height + "px";
			//pckry
					
		}
		
		function insert(id, content) {
			document.getElementById(id).innerHTML="<div>"+format(content,id)+"</div>";
			//new_height = document.getElementById('inner'+id).clientHeight;
			//document.getElementById(id).style.height = new_height + "px";
			//pckry
					
		}
		
		
		
		var boxen = ['bigMultimedia','boxOne','boxTwo','boxThree','boxFour','boxFive','boxSix',
						'boxSeven','boxEight','boxNine','boxTen','boxEleven',"mugshotPhoto",'mugshotBio',];
		var strings = ['bigHeadline', "mugshotName", "mugshotDates",];
		
		function swapLoop(id_list, data, fn) {
			for (i=0; i < id_list.length; i++) {
				val = id_list[i];
				if (data.hasOwnProperty(val)&data[val]!=""&data[val]!=null){
					//console.log(data[val]);
					fn(val, data[val]);
				} else {
				    document.getElementById(val).remove();
				}
			}
		}





		function bgImage(pagedata) {
			if (img.src) {
				bigDiv =  document.getElementById('bigPicture');
				bigDiv.style.backgroundImage = 'url('+pagedata.bigImage+')';
				if (document.body.clientWidth > img.width) {
					bigDiv.style.backgroundSize = 100 + "%";
				} else {
					bigDiv.style.backgroundSize = "";
				}
				
				if (img.height >= 500) {
					bigDiv.style.height = "500px";
				} else if (img.height >= 400) {
					bigDiv.style.height = "400px";
				} else if (img.height >= 300) {
					bigDiv.style.height = "300px";
					
				} else if (img.height >= 250) {
					bigDiv.style.height = "250px";
				} else {
					bigDiv.style.height = "250px";
					bigDiv.style.backgroundSize = 250/img.height * 100 + "%";
				}
			}
		}
		
		function init(pagedata) {
		

			img = new Image();
			if (pagedata.hasOwnProperty('bigImage')&pagedata.bigImage!="") {
				bigDiv =  document.getElementById('bigPicture');
				bigDiv.style.backgroundImage = 'url('+pagedata.bigImage+')';
				img.onload = function () {bgImage(pagedata)};
				img.src = pagedata.bigImage;
				document.getElementById('bigPicture').innerHTML = "<div>" + document.getElementById('bigPicture').innerHTML + "</div>";
			
			window.onresize = function () {bgImage(pagedata)};
			swapLoop(strings, pagedata, swap);
			swapLoop(boxen, pagedata, insert);
			reflowSettings.maps.forEach(makeMap);
			document.body.style.display="";
			} else {}
				
		}

	
		
		function makeMap(a, b, c) {
			console.log(a.div);
			console.log(a.address);
			console.log(a.bubble);
			toGeocode = { address: a.address, };
			reflowSettings.geocoder.geocode(toGeocode, function(results, status) {
      			if (status == google.maps.GeocoderStatus.OK) {
      			
        			var mapOptions = {
      					zoom: reflowSettings.zoomLevel,
      					center: results[0].geometry.location
    				}
    				document.getElementById(a.div).style.height = document.getElementById(a.div).parentElement.parentElement.clientWidth + "px";
    				var map = new google.maps.Map(document.getElementById(a.div), mapOptions);
        			var marker = new google.maps.Marker({
            			map: map,
            			position: results[0].geometry.location,
            			
        			});
        			
        			var infowindow = new google.maps.InfoWindow({
      					content: a.bubble,
  					});
  					google.maps.event.addListener(marker, 'click', function() {
    					infowindow.open(map,marker);
  					});

        			
      			} else {
        			alert("Geocode was not successful for the following reason: " + status);
      			}
   	 		});
		}


		function pack() {
			pckry.layout();
			//console.log('p');
		}
		
		
		
		function format(text, id) {
		//console.log(text);
			formatted = text;
			var rawImage = /( |\n|^)(\S*\.(jpg|png|gif))( |\n|$)/g;
			var isImage = /^\S*\.(jpg|png|gif)$/;
			var isBrightcove = /http:\/\/bcove.me.*/;
			var isBrightcoveId = /^\d+$/;
			var isYouTube = /^http:\/\/(youtu.be)|(youtube.com).*/;
			var isSlideshow = /^slideshow\:?\s*(\S*)/;
			var isTimeline = /^timeline\:?\n?/;
			var isLink = /^(http)?\:\/\/\S+\.\S+\s*$/;
			var isHTML = /^\<.*\>$/;
			//var isMap = /^map\:?\s*(.*)?\n(.*)$/;
			var isMap = /(map)\:?\s*(.+)\n(.+)/;

			if (isImage.test(text)) {
				formatted = "<img src='"+text+"'>";
			//console.log("i");
			} else if (isBrightcoveId.test(text)) {
				formatted = brightcovePlayer(text);
			//console.log("b")
			} else if (isSlideshow.test(text)) {
				id = 'slid' + Math.round(Math.random()*10000);
				formatted ="<div id='"+id+"' class='"+id+" bss-slides'></div>";
				link = isSlideshow.exec(text)[1]
				slideshow(link, id);
			//console.log("ss")
			} else if (isTimeline.test(text)) {
				text = text.replace(rawImage, "<img src='$2'>");
				newText = text.replace(isTimeline,"");
				formatted = marked(newText, {renderer: timelineRenderer});
			//console.log("tl");

			} else if (isHTML.test(text)) {
				formatted = text; // leave it as is
			//console.log("h");
			} else if (isMap.test(text)) {
				// build inline google map;
				regexResult = isMap.exec(text);
				resultObj =  {
					div: 'map'+id,
					address: regexResult[2],
					bubble: regexResult[3],
				}
				formatted = "<div class='map' id='map"+id+"'></div>";
				reflowSettings.maps.push(resultObj);
				
			} else {
				newText = text.replace(rawImage, "<img src='$2'>");
				formatted = marked(newText);
			//console.log(rawImage.exec(text));
				
			}
			return formatted;
		}


		/* parameter getter from james padolsey                                        */
		/* http://james.padolsey.com/javascript/bujs-1-getparameterbyname/             */
		function getParameterByName(name) {
 
			var match = RegExp('[?&]' + name + '=([^&]*)')
                    .exec(window.location.search);
 
			return match ?
				decodeURIComponent(match[1].replace(/\+/g, ' '))
				: null;
 
		}




	function slideshow(url, div) {
		var new_url = 'http://pipes.yahoo.com/pipes/pipe.run?_id=2FV68p9G3BGVbc7IdLq02Q&_render=json&feedcount=100&feedurl='+encodeURIComponent(url)+'&_callback=';
		//console.log(new_url);

		var slideds = new Miso.Dataset({ 
			url:  new_url,
			jsonp: true,
			extract: function(data){ return data.value.items;}
	
		});
		
		

		slideds.fetch({
			success: function() {
				el = document.getElementById(div);
				var a = "";
				slideds.each(function(row, rowIndex) {
					a +=  "<figure><img  width='100%' src='"+row.enclosure.url + "'>"
					a +=  "<figcaption>"
					a +=  row.description;
					a +=  "</figcaption></figure>";
  				});
  				el.innerHTML = a;
  				el.parentElement.outerHTML = el.outerHTML;
  				makeBSS('.'+div, opts);
  				pack();
  			}
  			
  		});
  		
  		
  	}
  			
	
	

			



	</script>



 
</head>



<body style="display:none;">



	<div id="bigPicture" class="fullwidth tall"><div><h1 id="bigHeadline"></h1></div></div>
	<div id="content" class="reflow">
			<div class="box" id="mugshot">
				<div id="mugshotPhoto"></div>
				<div id="mugshotCaption">
					<h2 id="mugshotName"></h2>
					<h3 id="mugshotDates"></h3>
					<div class="indentLeft" id="mugshotBio"></div>
				</div>
			</div>
			<div class="box w2col" id="bigMultimedia"></div>
			<div class="box w1col" id="boxOne"></div>	
			<div class="box w2col" id="boxTwo"></div>
			<div class="box w2col" id="boxThree"></div>
			<div class="box w2col" id="boxFour"></div>
			<div class="box w2col" id="boxFive"></div>
			<div class="box w1col" id="boxSix"></div>
			<div class="box w1col" id="boxSeven"></div>
		 	<div class="box w1col" id="boxEight"></div>
			<div class="box w1col" id="boxNine"></div>
			<div class="box w1col" id="boxTen"></div>
			<div class="box w1col" id="boxEleven"></div>


			
	</div>
	
	<script type="text/javascript">
	
	</script>
 
</body>
</html>